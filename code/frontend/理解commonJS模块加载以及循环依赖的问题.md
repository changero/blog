---
title: ç†è§£commonJSæ¨¡å—åŠ è½½ä»¥åŠå¾ªç¯ä¾èµ–çš„é—®é¢˜
date: 2019-06-29
categories: 
  - å‰ç«¯
  - ç¼–ç¨‹
tags: 
  - js
  - nodejs
  - commonjs
---


## commonjsæ¨¡å—çš„åŠ è½½æœºåˆ¶

commonjsä¸­ï¼Œä¸€ä¸ªè„šæœ¬æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œé€šè¿‡`exports`ã€æˆ–è€…`module.exports`æ¥å¯¼å‡ºå˜é‡æˆ–æ•°æ®ï¼Œå…¶å®è¿™ä¸¤è€…æœ¬è´¨ä¸Šæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå³`module.exports === exports`ã€‚

å½“æˆ‘ä»¬é€šè¿‡`require`å¯¼å…¥ä¸€ä¸ªæ¨¡å—çš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªæ¨¡å—æ²¡æœ‰è¢«åŠ è½½è¿‡ï¼Œå°±ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªæ¨¡å—å¯¹è±¡ï¼š

```js
{
    id: '...',
    exports: { ... },
    loaded: true,
}
```

`id`å°±æ˜¯æ¨¡å—åï¼Œ`exports`å°±æ˜¯å¯¼å‡ºçš„æ•°æ®å¯¹è±¡ï¼Œ`loaded`è¡¨ç¤ºå½“å‰æ¨¡å—æ˜¯å¦åŠ è½½å®Œæˆ

ä¸¾ä¸ªğŸŒ°ï¼š

```js
// main.js
const a = require('./a')
const a1 = reuqire('./a')

// a.js
console.log('this is module "a"');
```

æ‰§è¡Œ`main.js`ä¹‹åï¼Œå‘ç°æ§åˆ¶å°ä¸­åªæ‰“å°äº†ä¸€å¥ã€‚è¡¨æ˜ï¼Œåœ¨ç¬¬äºŒå¥`require`æ‰§è¡Œçš„æ—¶å€™ï¼Œaæ–‡ä»¶å¹¶æ²¡æœ‰è¢«å†æ¬¡æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è¿”å›äº†å†…å­˜ä¸­çš„æ¨¡å—å¯¹è±¡ã€‚æˆ‘ä»¬è¿›ä¸€æ­¥è¯æ˜ä¸€ä¸‹

```js
a === a1 // true
```

### module.exportså’Œexports

åœ¨æ¨¡å—çš„åˆå§‹åŒ–å®šä¹‰å½“ä¸­ï¼Œ`exports`å°±æ˜¯`module.exports`ï¼Œåªæ˜¯ä½¿ç”¨çš„å½¢å¼ä¸åŒï¼Œrequireå¼•å…¥ä¸€ä¸ªæ¨¡å—çš„æ—¶å€™å°†è¿”å›è¯¥æ¨¡å—çš„`module.exports`å˜é‡

```js
module.exports === exports
```

å› æ­¤åœ¨å¯¼å‡ºå˜é‡çš„æ—¶å€™è¦å°å¿ƒï¼Œä¸èƒ½ç›´æ¥å¯¹`exports`é‡æ–°èµ‹å€¼ï¼Œå¦åˆ™ï¼Œä¼šåˆ‡æ–­è·Ÿmoduleçš„è”ç³»

```js
exports.a = 'a' âœ…
module.exports.b = 'b'  âœ…

exports = {  âŒ
    c: 'c'
}
```

è¿™æ ·å°†ä¼šå¯¼è‡´cå¯¼å‡ºå¤±è´¥ï¼Œè€Œåªä¼šæœ‰aã€bä¸¤ä¸ªå˜é‡

 ## å¾ªç¯ä¾èµ–

 å¾ªç¯ä¾èµ–æŒ‡çš„æ˜¯åœ¨aæ¨¡å—ä¸­ä¾èµ–bæ¨¡å—ï¼Œè€Œåœ¨bæ¨¡å—ä¸­åˆè¿”å›æ¥ä¾èµ–aæ¨¡å—ã€‚è™½ç„¶åœ¨é¡¹ç›®ä¸­åº”è¯¥é¿å…å‡ºç°å¾ªç¯ä¾èµ–ï¼Œä½†å½“é¡¹ç›®è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œä¹Ÿä¸èƒ½å®Œå…¨é¿å…è¿™æ ·çš„é—®é¢˜å‘ç”Ÿã€‚aä¾èµ–b,bä¾èµ–cï¼Œcä¾èµ–aä¹ŸåŒæ ·æ˜¯å¾ªç¯ä¾èµ–ã€‚

 commonjsè§£å†³å¾ªç¯ä¾èµ–çš„ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼Œåœ¨è¢«ä¾èµ–æ¨¡å—(b)ä¸­ï¼Œå¼•å…¥ä¾èµ–æ¨¡å—(a)ï¼Œå¯¼å…¥çš„ä¾èµ–æ¨¡å—åªä¼šåŒ…å«å·²ç»è¾“å‡ºçš„éƒ¨åˆ†ï¼Œè€Œä¸ä¼šåŒ…å«æœªè¾“å‡ºçš„éƒ¨åˆ†

 ```js
// a.js
exports.name = 'a.js'

const b = require('./b');
exports.age = 1

// b.js

const a = require('./a')
console.log(a)
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œaæ¨¡å—ä¾èµ–äº†bæ¨¡å—ï¼Œbæ¨¡å—ä¹Ÿä¾èµ–äº†aæ¨¡å—ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾å­˜åœ¨å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚è€Œå®é™…ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯

1ã€ é¦–å…ˆåˆæ¬¡åŠ è½½aæ¨¡å—ï¼Œä¼šæ‰§è¡Œaæ¨¡å—ä¸­çš„ä»£ç ï¼Œå¯¼å‡ºä¸€ä¸ªnameå˜é‡

2ã€ å¼•å…¥bæ¨¡å—ï¼Œåˆæ¬¡åŠ è½½bæ¨¡å—ä¼šæ‰§è¡Œbæ¨¡å—çš„ä»£ç 

3ã€ åœ¨bæ¨¡å—ä¸­ï¼Œåˆå¼•å…¥aæ¨¡å—ï¼Œå› ä¸ºaæ¨¡å—å·²ç»åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥ç›´æ¥å¯¼å…¥module.exportså˜é‡

4ã€ æ­¤æ—¶å¯¼å…¥çš„aæ¨¡å—ä¸­åªæœ‰nameå±æ€§ï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„å˜é‡é‡Œé¢ä¹Ÿåªæœ‰nameå±æ€§

5ã€ bæ¨¡å—åŠ è½½å®Œæˆï¼Œaæ¨¡å—ä¸­ç»§ç»­è¿½åŠ ageå±æ€§ï¼Œæ‰€ä»¥ï¼Œæ­¤åè®¿é—®æˆ–å¯¼å…¥aæ¨¡å—å°±èƒ½è®¿é—®ageå±æ€§äº†

åœ¨ç¬¬5ç‚¹ä¸­ï¼Œåªè¦aæ¨¡å—åŠ è½½å®Œæˆå°±èƒ½è®¿é—®ageå±æ€§äº†ï¼Œæ‰€ä»¥ï¼Œåœ¨bæ¨¡å—ä¸­ï¼Œåªè¦ç­‰å¾…aæ¨¡å—åŠ è½½å®Œæˆå°±å¯ä»¥äº†ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªsettimeoutå‡½æ•°åšä¸ªæµ‹è¯•

```js
// b.js
setTimeout(()=>{
    console.log(a.age) // 1
}, 1000)
```

è¯æ˜ä¸Šé¢çš„ç†è§£æ˜¯æ­£ç¡®çš„

**ä»¥ä¸Šå°±æ˜¯æˆ‘å¯¹commonjsæ¨¡å—åŠ è½½çš„ç†è§£**

å‚è€ƒï¼š

- [æ¨¡å—ä¾èµ–](http://www.ruanyifeng.com/blog/2015/11/circular-dependency.html)

- [requireæºç è§£è¯»](http://www.ruanyifeng.com/blog/2015/05/require.html)





