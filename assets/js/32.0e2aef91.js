(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{355:function(s,a,t){s.exports=t.p+"assets/img/tunnel.0df03423.png"},566:function(s,a,t){"use strict";t.r(a);var n=t(14),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("img",{attrs:{src:"https://blog.cloudflare.com/content/images/2020/11/BLOG-314-Multi-Service-Support-for-Cloudflared.png"}}),s._v(" "),a("p",[s._v("这里说的 Tunnel 是 CloudFlare 的 Argo Tunnel Client 产品，可以将本地服务发布到 cloudflare，其原理类似 frp。只不过 frp 所需的服务器 IP 在 Argo Tunnel 中变成了 Cloudflare 提供的节点。相比运营商公网 IP，Argo Tunnel 省去了跟运营商扯皮的时间，相比于 frp 则省去了服务器的成本。")]),s._v(" "),a("h2",{attrs:{id:"准备工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),a("p",[s._v("首先要在 Cloudflare 中开通此服务，随便点击一个域名，在左侧导航找到"),a("code",[s._v("流量 > Cloudflare Tunnel")]),s._v("，进去之后根据提示开通即可")]),s._v(" "),a("img",{attrs:{src:t(355)}}),s._v(" "),a("h2",{attrs:{id:"环境安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境安装"}},[s._v("#")]),s._v(" 环境安装")]),s._v(" "),a("p",[s._v("在官方的"),a("a",{attrs:{href:"https://github.com/cloudflare/cloudflared/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("github 仓库"),a("OutboundLink")],1),s._v("，找到对应环境的包进行下来并且安装，例如 Ubuntu：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://ghproxy.com/https://github.com/cloudflare/cloudflared/releases/download/2022.7.1/cloudflared-linux-amd64.deb\ndpkg -i cloudflared-linux-amd64.deb\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("检测一下是否安装成功")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ cloudflared -v\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#登录"}},[s._v("#")]),s._v(" 登录")]),s._v(" "),a("p",[s._v("Argo Tunnel Client 需要使用者登录 Cloudflare 账号以进行授权，执行")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ cloudflared tunnel login\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("控制台会输出一个地址，复制到浏览器打开进行授权")]),s._v(" "),a("h2",{attrs:{id:"创建-tunnel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-tunnel"}},[s._v("#")]),s._v(" 创建 tunnel")]),s._v(" "),a("p",[s._v("在控制台输入")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("cloudflared tunnel create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tunnel name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果创建成功，会输出一个 UUID，并在"),a("code",[s._v("~/.cloudflared")]),s._v("目录下创建一个已 UUID 为文件名的 json 文件")]),s._v(" "),a("h2",{attrs:{id:"配置-dns-记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-dns-记录"}},[s._v("#")]),s._v(" 配置 DNS 记录")]),s._v(" "),a("p",[s._v("回到 cloudflare 的 dashboard，添加一条 CNAME 记录。解析值为"),a("code",[s._v("[UUID].cfargotunnel.com")])]),s._v(" "),a("blockquote",[a("p",[s._v("注意：解析记录的域名需要与授权的域名一致")])]),s._v(" "),a("h2",{attrs:{id:"创建配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建配置文件"}},[s._v("#")]),s._v(" 创建配置文件")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("~/.cloudflared")]),s._v("目录下创建一个"),a("code",[s._v("config.yml")]),s._v("文件，内容如下")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tunnel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tunnel 的名称或 UUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("credentials-file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /root/.cloudflared/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tunnel 的 UUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(".json\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("CNAME 记录名称"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("接入 CLoudflare 的域名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//localhost"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http_status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("可以在 ingress 下创建多个记录，查看"),a("a",{attrs:{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/configuration/local-management/ingress/",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"启动服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动服务"}},[s._v("#")]),s._v(" 启动服务")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("cloudflared tunnel --config /root/.cloudflared/config.yml run\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果不指定配置文件路径，cloudflared 会默认读取 ~/.cloudflared/config.yml，在浏览器中打开解析的 dns，如果能够访问，就表示配置成功了")]),s._v(" "),a("h2",{attrs:{id:"配置为系统服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置为系统服务"}},[s._v("#")]),s._v(" 配置为系统服务")]),s._v(" "),a("p",[s._v("执行")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("cloudflared "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("cloudflared 会新建 systemd 文件，其他系统可以查看"),a("a",{attrs:{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/run-tunnel/as-a-service/",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl start cloudflared\nsystemctl status cloudflared\nsystemctl restart cloudflared\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("通过"),a("code",[s._v("systemctl status cloudflared")]),s._v("可以看到此时配置文件为"),a("code",[s._v("/etc/cloudflared/config.yml")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("● cloudflared.service - cloudflared\n     Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/etc/systemd/system/cloudflared.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Mon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:05 CST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 27min ago\n   Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      Tasks: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("limit: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9316")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     Memory: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(".4M\n     CGroup: /system.slice/cloudflared.service\n             └─986977 /usr/bin/cloudflared --no-autoupdate --config /etc/cloudflared/config.yml tunnel run\n\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:04 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:04Z INF Settings: map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config:/etc/cloudflared/config.yml cred-file:/root/.cloudflared/e684dbfd-d511-44c6-aabc-9f0e7c54e069.json credentials-file:/root/.cloudflared/e684dbfd-d51"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v("\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:04 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:04Z INF cloudflared will not automatically update "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" installed by a package manager.\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:04 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:04Z INF Generated Connector ID: 5aff6210-436b-4f8f-956f-820d5487bb7c\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:04 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:04Z INF Initial protocol quic\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:04 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:04Z INF Starting metrics server on "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:38243/metrics\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:05 nas cloudflared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("986977")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-07-11T13:23:05Z INF Connection 795e1d45-0d0b-403e-bf8d-baeaac82a7a8 registered "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("connIndex")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("198.41")]),s._v(".200.63 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("location")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("SJC\nJul "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":23:05 nas systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Started cloudflared\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("所以此后修改配置之后需要将文件复制到"),a("code",[s._v("/etc/cloudflared/config.yml")]),s._v("，也可以在"),a("code",[s._v("/etc/systemd/system/cloudflared.service")]),s._v("文件中修改配置文件的地址")]),s._v(" "),a("p",[s._v("最后执行重启"),a("code",[s._v("systemctl restart cloudflared")]),s._v("。")])])}),[],!1,null,null,null);a.default=e.exports}}]);