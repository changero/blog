<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息推送 | 编程小兵</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="路漫漫其修远兮，吾将上下而求索">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/css/0.styles.f1c3a865.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/app.03a08a11.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/3.2b593545.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/9.013d5b21.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/10.3c93f85b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/100.7f414aae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/101.2348dd18.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/102.8af3f469.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/103.8bb649de.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/104.d64fb347.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/105.ce0c9777.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/106.11da9663.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/107.6acbdc97.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/108.522fe21c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/109.a5bba632.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/11.ebed3f6f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/110.8f156d97.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/111.86c67076.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/112.5f49a31b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/113.b26c7462.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/114.696b6195.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/115.2af18a7e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/116.e95ec34b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/117.1dc05831.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/118.5dbd64d6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/119.49418e53.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/12.cd6b919a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/120.4fcffafe.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/121.e9e032e8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/122.60e037d9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/123.31fd7f53.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/124.254abdee.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/125.3cbe3455.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/126.60d98d65.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/127.cd76235a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/128.5cd53b9c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/129.74c81192.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/13.d3406d66.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/130.9b74fda3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/131.1fab962e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/132.bb81e1a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/133.94586e72.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/134.4ef040b8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/135.d2982bab.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/136.2ba31a05.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/137.299dac49.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/138.30c41acb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/139.eeb4e298.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/14.b7b3520d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/140.0f0f8a8d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/141.67b75bcc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/142.e95b1380.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/143.81e92e93.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/144.96d2cd63.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/145.55a54f9b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/146.1e0e4953.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/147.2db0addc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/148.dc37b068.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/149.b5354a4c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/15.adead415.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/150.5dcd2ab8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/151.8357eebe.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/152.667a6f6a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/153.bc994aab.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/154.86570747.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/155.a2a0d4fd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/156.61782a3b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/157.f59cfc6d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/158.0f57c646.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/159.8d0a1739.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/16.3544c358.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/160.48cbf202.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/161.eb7e545f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/162.e4ea72d1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/163.e46cc598.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/164.59d1735d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/165.6c85b5c7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/166.5c1d7f30.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/167.bb9c87a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/168.63c70fd6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/169.c082d58b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/17.d70afb94.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/170.691c62bb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/171.e461bfff.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/172.cd727d86.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/173.6d2f51bf.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/174.e9a00beb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/175.2023cb01.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/176.def07199.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/177.29f50ff6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/178.3dfef38b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/179.4a00d540.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/18.d6e9fd63.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/180.1bc4c639.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/181.ee4d4b4a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/182.e327e124.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/183.94d61f56.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/184.641beef6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/185.e89df33e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/186.33ca1636.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/187.27e9b734.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/188.a9718893.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/189.21aa469c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/19.9eb46e36.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/190.1102ac4e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/191.117892d3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/192.5ee14712.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/193.e886b9a7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/194.bbcbf647.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/195.35930876.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/196.6b417531.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/197.eb7df7db.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/198.b95c627a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/199.a0fad090.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/2.948e236e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/20.06ec23d0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/200.b9a3c912.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/201.ea81c5d7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/202.bedf7c48.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/203.43c72de0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/204.9c02e833.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/205.850f2d2d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/206.40e6135c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/207.bfe34217.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/208.a35aa765.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/209.f701b600.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/21.c7310922.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/210.f061322f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/211.e834fce2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/22.a1625bb5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/23.6267640b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/24.1696d1e8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/25.c4c34c07.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/26.54468745.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/27.22f30c94.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/28.fd7f6d68.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/29.376af419.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/30.259ca070.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/31.1f391c2e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/32.0e2aef91.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/33.bdd940e3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/34.5e9ebf1a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/35.5f690222.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/36.6d527b07.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/37.92a94efa.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/38.ccb8d5c4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/39.6e88d2db.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/4.9fca145c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/40.b4f4bc7a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/41.024ab758.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/42.8aa4f572.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/43.2f721fd6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/44.fc4763d0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/45.ce43007f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/46.cc56f930.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/47.7cff0305.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/48.4a64fde0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/49.92b28a8d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/5.afe584f1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/50.bb382a13.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/51.1796af05.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/52.3a52b0c8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/53.e4527fb1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/54.23cd3cbd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/55.0160435a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/56.0af7bbe2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/57.b81f2a64.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/58.1a8c6276.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/59.11c44d96.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/6.9c204179.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/60.e78e9edc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/61.9d75209e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/62.d9f26614.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/63.df8b3b78.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/64.9b2f3798.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/65.0422633e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/66.e9465fb5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/67.ef504779.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/68.0d2a9987.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/69.a18bc029.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/7.23f16619.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/70.7b55a276.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/71.37d3a981.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/72.a4bf3fe5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/73.9eec09bc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/74.a3152b49.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/75.cc45d0ab.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/76.baaef140.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/77.ccb60a9a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/78.9890fb43.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/79.6355e3b0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/8.08d1e0f6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/80.163254c4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/81.8f67b062.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/82.e187c6c5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/83.567090ad.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/84.05f67456.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/85.a8363035.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/86.ad1f37ee.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/87.1b5b8331.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/88.a55c2a56.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/89.f76e674f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/90.379e76c0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/91.67d52c2a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/92.d61adf71.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/93.f04d9e7f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/94.9c76f5da.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/95.9b8ace03.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/96.64e73c2e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/97.ee2b3ef1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/98.e106b68f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/99.9f8cc9f5.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/css/0.styles.f1c3a865.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/hero.png" alt="编程小兵" class="logo"> <span class="site-name can-hide">编程小兵</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/share/" class="nav-link">
  分享
</a></div><div class="nav-item"><a href="/read/" class="nav-link">
  记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/code/frontend/" class="nav-link">
  frontend
</a></li><li class="dropdown-item"><!----> <a href="/code/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-item"><!----> <a href="/code/tools/" class="nav-link">
  tools
</a></li><li class="dropdown-item"><!----> <a href="/code/rxjs/" class="nav-link">
  rxjs
</a></li><li class="dropdown-item"><!----> <a href="/code/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/code/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/code/electron/" class="nav-link">
  electron
</a></li><li class="dropdown-item"><!----> <a href="/code/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/code/android/" class="nav-link">
  android
</a></li><li class="dropdown-item"><!----> <a href="/code/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/code/other/" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="/code/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/code/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/code/linux/linux学习笔记.html" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><a href="/navs/" class="nav-link">
  资源导航
</a></div><div class="nav-item"><a href="mailto://changero@126.com" class="nav-link external">
  联系我
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/share/" class="nav-link">
  分享
</a></div><div class="nav-item"><a href="/read/" class="nav-link">
  记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><span class="title">编程</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程" class="mobile-dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/code/frontend/" class="nav-link">
  frontend
</a></li><li class="dropdown-item"><!----> <a href="/code/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-item"><!----> <a href="/code/tools/" class="nav-link">
  tools
</a></li><li class="dropdown-item"><!----> <a href="/code/rxjs/" class="nav-link">
  rxjs
</a></li><li class="dropdown-item"><!----> <a href="/code/git/" class="nav-link">
  git
</a></li><li class="dropdown-item"><!----> <a href="/code/docker/" class="nav-link">
  docker
</a></li><li class="dropdown-item"><!----> <a href="/code/electron/" class="nav-link">
  electron
</a></li><li class="dropdown-item"><!----> <a href="/code/python/" class="nav-link">
  python
</a></li><li class="dropdown-item"><!----> <a href="/code/android/" class="nav-link">
  android
</a></li><li class="dropdown-item"><!----> <a href="/code/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/code/other/" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="/code/db/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/code/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/code/linux/linux学习笔记.html" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><a href="/navs/" class="nav-link">
  资源导航
</a></div><div class="nav-item"><a href="mailto://changero@126.com" class="nav-link external">
  联系我
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>配置</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>消息服务器开发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/code/node/socket-server/" aria-current="page" class="sidebar-link">关于</a></li><li><a href="/code/node/socket-server/net.html" class="sidebar-link">消息服务器之net</a></li><li><a href="/code/node/socket-server/tcp双向通信.html" class="sidebar-link">tcp双向通信</a></li><li><a href="/code/node/socket-server/简易聊天室.html" class="sidebar-link">简易聊天室</a></li><li><a href="/code/node/socket-server/socket.io入门.html" class="sidebar-link">socket.io入门</a></li><li><a href="/code/node/socket-server/socket.io自定义事件与认证.html" class="sidebar-link">socket.io自定义事件与认证</a></li><li><a href="/code/node/socket-server/socket命名空间.html" class="sidebar-link">socket命名空间</a></li><li><a href="/code/node/socket-server/消息推送.html" class="active sidebar-link">消息推送</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/code/node/socket-server/消息推送.html#评价标准" class="sidebar-link">评价标准</a></li><li class="sidebar-sub-header"><a href="/code/node/socket-server/消息推送.html#推送方式" class="sidebar-link">推送方式</a></li><li class="sidebar-sub-header"><a href="/code/node/socket-server/消息推送.html#mqtt" class="sidebar-link">MQTT</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="评价标准"><a href="#评价标准" class="header-anchor">#</a> 评价标准</h2> <p>消息推送有许多的方案，比如长轮询、短轮训等。如何评价一个方案呢，目前采用<code>4S</code>标准，即：</p> <ul><li>安全(safe)：安全性</li> <li>稳定(Stable)：同时在线、高并发的延迟、高可用（断线重连）</li> <li>节省(Save)：对于客户端主要是两个指标，功耗以及流量消耗</li> <li>体积小(Slim)</li></ul> <h2 id="推送方式"><a href="#推送方式" class="header-anchor">#</a> 推送方式</h2> <ul><li>HTTP 推送：包括长轮询、短轮训、WebSocket</li> <li>XMPP 拦截</li> <li>SMS 拦截</li> <li>MQTT（物联网采用的方式）</li></ul> <h2 id="mqtt"><a href="#mqtt" class="header-anchor">#</a> MQTT</h2> <p>MQTT(Message Queueing Telemetry Transport)消息队列遥测传输，是 IBM 开发的一个即使通信协议。有可能成为物联网重要组成部分，该协议支持所有平台，几乎可以把所有联网物品和外部连接起来，被用来当做传感器和致动器的通信协议</p> <h3 id="mqtt-的特点"><a href="#mqtt-的特点" class="header-anchor">#</a> MQTT 的特点</h3> <ul><li><p>MQTT 采用发布订阅的模式，提供一对多的消息发布，解除应用程序的耦合</p></li> <li><p>对负载内容屏蔽的消息传输</p></li> <li><p>基于 TCP/IP 的网络协议</p></li> <li><p>三种消息发布质量：至多一次、至少一次、只有一次</p></li> <li><p>小型传输，开销很小（头部固定 2 个字节），协议交换最小化，以降低网络流量</p></li> <li><p>使用 Last Will 和 Testament 特性通知有关各客户端异常终端的机制</p></li></ul> <p>相关参考:</p> <ul><li><a href="https://mqtt.org/" target="_blank" rel="noopener noreferrer">mqtt 官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/mcxiaoke/mqtt" target="_blank" rel="noopener noreferrer">中文资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://mcxiaoke.gitbook.io/mqtt/" target="_blank" rel="noopener noreferrer">对应文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>在 Node 平台下，我们将使用<a href="https://github.com/mqttjs/MQTT.js" target="_blank" rel="noopener noreferrer">mqtt.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以及<a href="https://github.com/moscajs/mosca" target="_blank" rel="noopener noreferrer">mosca<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="mosca"><a href="#mosca" class="header-anchor">#</a> mosca</h4> <p>mosca 是 Mqtt 的一个代理，通过它我们可以在 node 上运行 mqtt Server，通过<code>npm install mosca</code>来安装。mosca 本身不具备集群的功能，如果要扩展，需要借助第三方的库，如 Redis、Mongodb、ZeroMQ 等</p> <p>Events</p> <ul><li>ready</li> <li>error</li> <li>published</li> <li>subscribed</li> <li>unsubscribed</li> <li>clientConnected</li> <li>clientDisconnected</li></ul> <p>安装好 mosca 之后，我们来创建第一个服务，<code>touch server.js</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mosca <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mosca'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8957</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mosca<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mosca server started'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这样 mqtt 服务就启动好了，接下来我们就要去实现客户端，为了能够在服务端看到客户端的连接，我们再添加一个<code>clientConnected</code>事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'clientConnected'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'clientConnected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>客户端的实现使用 mqtt 包</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mqtt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mqtt://localhost:8957'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client connect to server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在启动客户端和服务端就能看到控制台的消息了</p> <img src="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/img/mqtt.5a37f447.png"> <h5 id="收发消息"><a href="#收发消息" class="header-anchor">#</a> 收发消息</h5> <p>之前说了 mosca 只是 mqtt 的一个代理，不会处理消息本身，为了完成收发消息，我们分别在两个客户端上分别实现，代码分别如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// client1.js</span>
<span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mqtt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mqtt://localhost:8957'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pubTopic <span class="token operator">=</span> <span class="token string">'sys/pub1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> subTopic <span class="token operator">=</span> <span class="token string">'sys/sub1'</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client connect to server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>subTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubTopic<span class="token punctuation">,</span> <span class="token string">'msg from client1: Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// client2.js</span>
<span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mqtt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mqtt://localhost:8957'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> subTopic <span class="token operator">=</span> <span class="token string">'sys/pub1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pubTopic <span class="token operator">=</span> <span class="token string">'sys/sub1'</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client connect to server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>subTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubTopic<span class="token punctuation">,</span> <span class="token string">'msg from client2: Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>注意每个客户端对应的发布和订阅 channel 的对应关系</p> <h5 id="在浏览器中使用"><a href="#在浏览器中使用" class="header-anchor">#</a> 在浏览器中使用</h5> <p>首先需要修改 server.js 的 settings 参数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8957</span><span class="token punctuation">,</span> <span class="token comment">// 提供给nodejs的客户端调用</span>
  <span class="token literal-property property">http</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8956</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 向客户端提供对应的bundle文件</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>而在客户端，也需要使用 mqtt 模块来连接上服务，在 server 的 settings 中，我们已经添加了字段<code>http.bundle: true</code>，意味着我们可以通过这个端口获取对应的包</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://localhost:8956/mqtt.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>拿到模块以后，接下来的事情和在 node 平台下作的没有区别</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mqtt://localhost:8956'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> subTopic <span class="token operator">=</span> <span class="token string">'sys/pub1'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pubTopic <span class="token operator">=</span> <span class="token string">'sys/sub1'</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client connect to server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>subTopic<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubTopic<span class="token punctuation">,</span> <span class="token string">'msg from browser: Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>仔细观察这部分，相对于 client2 文件，其实只修改了很少的部分，首先是连接的端口，修改成了 http 配置下端口，另外则是将 pub 出去的消息修改为了<code>from browser</code>，这样我们在 client1 的控制台就能看到</p> <img src="data:image/png;base64,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"> <p>以及在浏览器的控制台看到</p> <img src="data:image/png;base64,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"> <h4 id="主题树"><a href="#主题树" class="header-anchor">#</a> 主题树</h4> <p>我们在订阅 topic 的时候，需要与 publish 的 topic 完全一致才能够接收到消息，比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'node1/node2/node3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'node1/node2/node3'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样 client 就能在 message 事件中接收到消息了。</p> <p>另外一种订阅消息的方式是通过通配符来进行匹配，通配符有 2 种，一种用<code>#</code>表示，一种用<code>+</code>号表示,它们的区别如下:</p> <p><code>client.subscribe('node1/node2/+')</code>可以匹配的 channel 如下:</p> <ul><li>node1/node2/</li> <li>node1/node2/node3</li></ul> <p>但是不能匹配<code>node/node2</code>、<code>node1/node2/node3/</code>，也就是说/后面的+表示的是此后不能再出现<code>/</code></p> <p>另一种<code>client.subscribe('node1/node2/#')</code>可以匹配的 channel 如下:</p> <ul><li>node1/node2</li> <li>node1/node2/</li> <li>node1/node2/node3</li> <li>node1/node2/node3/</li> <li>node1/node2/node3/node4</li></ul> <p>可以看到<code>#</code>的匹配比<code>+</code>宽松许多</p> <h4 id="acl"><a href="#acl" class="header-anchor">#</a> ACL</h4> <p>ACL 全称 Access ControlList，访问控制列表，RBAC 则是更高层次的一个封装，在 mosca 中主要通过 acl 来进行基于用户的访问控制，提供了一个<code>Authorizer</code>方法，可以控制用户的访问，也可以控制用户能够发布哪些主题，订阅哪些主题</p> <p>首先在 server 中创建一个 auth 模块出来</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> auth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mosca<span class="token punctuation">.</span>Authorizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> authenticate <span class="token operator">=</span> auth<span class="token punctuation">.</span>authenticate<span class="token punctuation">;</span>
<span class="token keyword">const</span> authenticatePublish <span class="token operator">=</span> auth<span class="token punctuation">.</span>authenticatePublish<span class="token punctuation">;</span>
<span class="token keyword">const</span> authenticateSubscribe <span class="token operator">=</span> auth<span class="token punctuation">.</span>authenticateSubscribe<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着就是在 server 的 ready 事件发生的时候，将模块添加到 server 上</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  server<span class="token punctuation">.</span>authenticate <span class="token operator">=</span> authenticate<span class="token punctuation">;</span>
  server<span class="token punctuation">.</span>authenticatePublish <span class="token operator">=</span> authenticatePublish<span class="token punctuation">;</span>
  server<span class="token punctuation">.</span>authenticateSubscribe <span class="token operator">=</span> authenticateSubscribe<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此时我们再通过客户端去访问，将得到这样的错误</p> <img src="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/img/auth.65a31852.png"> <p>将用户添加到白名单中也很简单，调用<code>auth.addUser</code>即可，移除用户可以调用<code>rmUser</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>auth<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add user fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'add user success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

auth<span class="token punctuation">.</span><span class="token function">rmUser</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后再去修改客户端的连接方式，将用户名密码带过去</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mqtt://localhost:8956'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样就可以正常访问了</p> <p>另外基于主题的发布和订阅控制，主需要在<code>addUser</code>的时候传递第三个参数和第四个参数，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>auth<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'sys/*'</span><span class="token punctuation">,</span> <span class="token string">'sub/*'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样，这个用户就只能发布 sys 的主题，订阅 sub 的主题</p> <p>自定义的权限校验，可以自己手动实现 authenticate 的功能</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>server<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 权限不通过</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 权限通过</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function-variable function">authenticatePublish</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不允许发布</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许发布</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function-variable function">authenticateSubscribe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/code/node/socket-server/socket命名空间.html" class="prev">
        socket命名空间
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/app.03a08a11.js" defer></script><script src="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/3.2b593545.js" defer></script><script src="https://cdn.jsdelivr.net/gh/changero/blog@gh-pages/assets/js/9.013d5b21.js" defer></script>
  </body>
</html>
