---
title: 文件系统
date: '2022-04-10 21:37:23'
categories:
  - 前端
lang: zh-cn
---

## 概述

文件访问是一个 web API，它允许用户直接对本地文件进行读写。这使得我们可以构建更强大的 web 应用，例如文本编辑器、web IDE、图像编辑器等。

<img src="https://i0.wp.com/css-tricks.com/wp-content/uploads/2022/02/file-system-prompt.png.webp?resize=1000%2C633&ssl=1" />

## 使用文件系统 API 访问读取文件

### 从单个文件读取

下面是一个简单的示例:

```js
const btn = document.querySelector('.btn');
btn.addEventListener('click', async () => {
  const [fileHandle] = await window.showOpenFilePicker();
  const file = await fileHandle.getFile();
  const content = await file.text();
});
```

在上面通过`showOpenFilePicker`方法，我们可以得到一个`FileSystemFileHandle` 数组，这些就代表我们选择的文件。

<!-- more -->

```js
FileSystemFileHandle {kind: 'file', name: 'data.txt'}
```

通过 fileHandle 的 getFile 方法，我们就能得到 file 对象，这与通过 file 组件选择的文件对象是一致的。包含了几个属性，如：文件名、文件大小、文件类型等

最后我们通过 text 方法获取文件内容

### 读取多个文件

要读取多个文件，我们需要给`showOpenFilePicker`方法传递一个对象

```js
const options = {
  multiple: true,
};
const [fileHandle] = await window.showOpenFilePicker(options);
```

该对象还接收其他属性，比如：我们想要控制可以选择的文件

```js
const options = {
  types: [
    {
      description: 'Images',
      accept: {
        'image/jpeg': '.jpeg',
      },
    },
  ],
  excludeAcceptAllOption: true,
};
```

所以读取多个文件，的示例如下：

```js
const options = {
  multiple: true,
  types: [
    {
      description: 'Images',
      accept: {
        'image/jpeg': '.jpeg',
      },
    },
    {
      description: 'text file',
      accept: {
        'text/plain': '.txt',
      },
    },
  ],
  excludeAcceptAllOption: true,
};

btn.addEventListener('click', async () => {
  const fileHandles = await window.showOpenFilePicker(options);
  const allContent = await Promise.all(
    fileHandles.map(async (fileHandle) => {
      const file = await fileHandle.getFile();
      const content = await file.text();
      return content;
    })
  );

  console.log(content);
});
```

## 使用文件系统 API 写入文件

### 写入新文件

写入文件的示例：

```js
document.querySelector('.save-file').onclick = async () => {
  const options = {
    types: [
      {
        description: 'Test files',
        accept: {
          'text/plain': ['.txt'],
        },
      },
    ],
  };

  const handle = await window.showSaveFilePicker(options);
  const writable = await handle.createWritable();

  await writable.write('Hello World');
  await writable.close();

  return handle;
};
```

我们使用`showSaveFilePicker`方法打开一个文件选择框，用返回的对象创建一个文件的写入流，在流中写入文件内容，最后关闭该流。

如果我们要写入其他格式的文件，例如 HTML 文件，我们只需要在 write 方法中传递相应的类型就可以

```js
btn.addEventListener('click', async () => {
  const options = {
    types: [
      {
        description: 'HTML',
        accept: {
          'text/html': ['.html'],
        },
      },
    ],
  };

  const handle = await window.showSaveFilePicker(options);
  const writable = await handle.createWritable();

  await writable.write('<h1>Hello world</h1>', { type: 'text/html' });
  await writable.close();

  return handle;
});
```

### 编辑一个已存在的文件

如果你想要导入一个文件并编辑他，就可以像下面的示例这样做：

```js
document.querySelector('.btn-a').onclick = async () => {
  [fileHandle] = await window.showOpenFilePicker();

  const file = await fileHandle.getFile();
  const writable = await fileHandle.createWritable();

  await writable.write('This is a new line');
  await writable.close();
};
```

如果你的文件已经有内容，旧的内容将会被写入的内容覆盖掉

## 其他功能

### 读取目录

```js
document.querySelector('.read-dir').onclick = async () => {
  const directoryHandle = await window.showDirectoryPicker();

  for await (const entry of directoryHandle.values()) {
    console.log(entry.kind, entry.name);
  }
};
```

### 删除文件

```js
document.querySelector('.pick-file').onclick = async () => {
  const [fileHandle] = await window.showOpenFilePicker();
  await fileHandle.remove();
};
```

如果要删除文件夹，只需对上面的代码示例进行少量更改：

```js
document.querySelector('.read-dir').onclick = async () => {
  const directoryHandle = await window.showDirectoryPicker();
  await directoryHandle.remove();
};
```

最后，如果要在选择文件夹时删除特定文件，可以这样编写：

```js
document.querySelector('.pick-folder').onclick = async () => {
  const directoryHandle = await window.showDirectoryPicker();
  await directoryHandle.removeEntry('data.txt');
};
```

如果要删除整个文件夹，则需要以下行：

```js
document.querySelector('.pick-folder').onclick = async () => {
  const directoryHandle = await window.showDirectoryPicker();
  await directoryHandle.removeEntry('data', { recursive: true });
};
```

## 浏览器支持

目前只支持 86+的 Edge 和 Chrome 以及 72+的 Opera。但是，存在一个名为`browser-fs-access`的库

## 结束语

如果您想试用文件系统访问 API，请查看由 Google 工程师构建的此[实时演示文本编辑器](https://googlechromelabs.github.io/text-editor/)。果您想了解有关此 API 及其所有功能的更多信息，请提供以下资源：

- [文件访问系统 API](https://wicg.github.io/file-system-access/) （W3C 规范）
- [文件访问系统接口](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API) (MDN)
- [Contrast Ratio Range, replaceAll Method, Native File System API ](https://css-tricks.com/weekly-platform-news-contrast-ratio-range-replaceall-method-native-file-system-api/#aa-try-out-the-native-file-system-api-in-chrome)
- [The File System Access API: simplifying access to local files (web.dev)](https://web.dev/file-system-access/#deleting-files-and-folders-in-a-directory)
- [Reading and writing files and directories with the browser-fs-access library (web.dev)](https://web.dev/browser-fs-access/)
- [https://github.com/GoogleChromeLabs/browser-fs-access](GitHub)
