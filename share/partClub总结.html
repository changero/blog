<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>零件俱乐部总结 | Changero</title>
    <meta name="description" content="技术只是工具，不是目的">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.fe5aacdd.css" as="style"><link rel="preload" href="/assets/js/app.3771b3c4.js" as="script"><link rel="preload" href="/assets/js/5.aeb3d5b3.js" as="script"><link rel="preload" href="/assets/js/1.8be823b2.js" as="script"><link rel="preload" href="/assets/js/51.d9e503ee.js" as="script"><link rel="prefetch" href="/assets/js/10.bcf31d95.js"><link rel="prefetch" href="/assets/js/11.41c37008.js"><link rel="prefetch" href="/assets/js/12.159d39b7.js"><link rel="prefetch" href="/assets/js/13.51bb3dec.js"><link rel="prefetch" href="/assets/js/14.c6f2d39f.js"><link rel="prefetch" href="/assets/js/15.8eae04d9.js"><link rel="prefetch" href="/assets/js/16.e6fd340f.js"><link rel="prefetch" href="/assets/js/17.d69121ff.js"><link rel="prefetch" href="/assets/js/18.f16407c4.js"><link rel="prefetch" href="/assets/js/19.5c6a6db0.js"><link rel="prefetch" href="/assets/js/20.f82c9423.js"><link rel="prefetch" href="/assets/js/21.37668836.js"><link rel="prefetch" href="/assets/js/22.e935434b.js"><link rel="prefetch" href="/assets/js/23.7b06393c.js"><link rel="prefetch" href="/assets/js/24.366d2145.js"><link rel="prefetch" href="/assets/js/25.31a1adbc.js"><link rel="prefetch" href="/assets/js/26.830f3aa2.js"><link rel="prefetch" href="/assets/js/27.9cb2ac86.js"><link rel="prefetch" href="/assets/js/28.d3915013.js"><link rel="prefetch" href="/assets/js/29.154f7316.js"><link rel="prefetch" href="/assets/js/3.a791917c.js"><link rel="prefetch" href="/assets/js/30.4f260c11.js"><link rel="prefetch" href="/assets/js/31.91ad6c4c.js"><link rel="prefetch" href="/assets/js/32.bdbc4dbc.js"><link rel="prefetch" href="/assets/js/33.501af1d4.js"><link rel="prefetch" href="/assets/js/34.ce4f84f3.js"><link rel="prefetch" href="/assets/js/35.6927d9be.js"><link rel="prefetch" href="/assets/js/36.0a732e3f.js"><link rel="prefetch" href="/assets/js/37.69540c1d.js"><link rel="prefetch" href="/assets/js/38.dd88023b.js"><link rel="prefetch" href="/assets/js/39.27d975d6.js"><link rel="prefetch" href="/assets/js/4.2558858c.js"><link rel="prefetch" href="/assets/js/40.fc59f1f4.js"><link rel="prefetch" href="/assets/js/41.329633fc.js"><link rel="prefetch" href="/assets/js/42.ff7186e5.js"><link rel="prefetch" href="/assets/js/43.11f997be.js"><link rel="prefetch" href="/assets/js/44.7dab79cc.js"><link rel="prefetch" href="/assets/js/45.14db7584.js"><link rel="prefetch" href="/assets/js/46.d03f5e69.js"><link rel="prefetch" href="/assets/js/47.bfdfd2bd.js"><link rel="prefetch" href="/assets/js/48.146ed0e3.js"><link rel="prefetch" href="/assets/js/49.f8b845a8.js"><link rel="prefetch" href="/assets/js/50.16f3b2c6.js"><link rel="prefetch" href="/assets/js/52.82780a85.js"><link rel="prefetch" href="/assets/js/53.79b2351f.js"><link rel="prefetch" href="/assets/js/54.dea25b54.js"><link rel="prefetch" href="/assets/js/55.093801f1.js"><link rel="prefetch" href="/assets/js/56.8199cc59.js"><link rel="prefetch" href="/assets/js/57.5d1bf8f2.js"><link rel="prefetch" href="/assets/js/6.5c4f1a6a.js"><link rel="prefetch" href="/assets/js/7.3ecfae8c.js"><link rel="prefetch" href="/assets/js/8.dfe08c7c.js"><link rel="prefetch" href="/assets/js/9.e4c92739.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fe5aacdd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Changero</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/aboutme/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/前端.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/category/编程.html" class="nav-link"><i class="iconfont undefined"></i>
  编程
</a></li><li class="dropdown-item"><!----> <a href="/category/心得.html" class="nav-link"><i class="iconfont undefined"></i>
  心得
</a></li><li class="dropdown-item"><!----> <a href="/category/趣味.html" class="nav-link"><i class="iconfont undefined"></i>
  趣味
</a></li><li class="dropdown-item"><!----> <a href="/category/计算机.html" class="nav-link"><i class="iconfont undefined"></i>
  计算机
</a></li><li class="dropdown-item"><!----> <a href="/category/工具.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/share/" class="nav-link router-link-active"><i class="iconfont reco-up"></i>
  分享
</a></div><div class="nav-item"><a href="/read/" class="nav-link"><i class="iconfont reco-search"></i>
  读书
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-menu"></i>
      编程
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code/frontend/" class="nav-link"><i class="iconfont undefined"></i>
  frontend
</a></li><li class="dropdown-item"><!----> <a href="/code/typescript/" class="nav-link"><i class="iconfont undefined"></i>
  typescript
</a></li><li class="dropdown-item"><!----> <a href="/code/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/code/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/code/tools/" class="nav-link"><i class="iconfont undefined"></i>
  tools
</a></li><li class="dropdown-item"><!----> <a href="/code/rxjs/" class="nav-link"><i class="iconfont undefined"></i>
  rxjs
</a></li><li class="dropdown-item"><!----> <a href="/code/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="http://quan.changero.win" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-other"></i>
  好有券
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="mailto://changero@126.com" class="nav-link external"><i class="iconfont reco-message"></i>
  联系我
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/aboutme/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/前端.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/category/编程.html" class="nav-link"><i class="iconfont undefined"></i>
  编程
</a></li><li class="dropdown-item"><!----> <a href="/category/心得.html" class="nav-link"><i class="iconfont undefined"></i>
  心得
</a></li><li class="dropdown-item"><!----> <a href="/category/趣味.html" class="nav-link"><i class="iconfont undefined"></i>
  趣味
</a></li><li class="dropdown-item"><!----> <a href="/category/计算机.html" class="nav-link"><i class="iconfont undefined"></i>
  计算机
</a></li><li class="dropdown-item"><!----> <a href="/category/工具.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/share/" class="nav-link router-link-active"><i class="iconfont reco-up"></i>
  分享
</a></div><div class="nav-item"><a href="/read/" class="nav-link"><i class="iconfont reco-search"></i>
  读书
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-menu"></i>
      编程
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code/frontend/" class="nav-link"><i class="iconfont undefined"></i>
  frontend
</a></li><li class="dropdown-item"><!----> <a href="/code/typescript/" class="nav-link"><i class="iconfont undefined"></i>
  typescript
</a></li><li class="dropdown-item"><!----> <a href="/code/react/" class="nav-link"><i class="iconfont undefined"></i>
  react
</a></li><li class="dropdown-item"><!----> <a href="/code/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/code/tools/" class="nav-link"><i class="iconfont undefined"></i>
  tools
</a></li><li class="dropdown-item"><!----> <a href="/code/rxjs/" class="nav-link"><i class="iconfont undefined"></i>
  rxjs
</a></li><li class="dropdown-item"><!----> <a href="/code/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="http://quan.changero.win" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-other"></i>
  好有券
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="mailto://changero@126.com" class="nav-link external"><i class="iconfont reco-message"></i>
  联系我
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>分享</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/share/" class="sidebar-link">介绍</a></li><li><a href="/share/cookie、session和token.html" class="sidebar-link">cookie、session、token</a></li><li><a href="/share/tools.html" class="sidebar-link">工具分享</a></li><li><a href="/share/aboutearth.html" class="sidebar-link">你相信地球只有人类文明吗</a></li><li><a href="/share/how-to-create-github-pages.html" class="sidebar-link">如何创建一个github pages仓库</a></li><li><a href="/share/node-commander.html" class="sidebar-link">node命令行工具</a></li><li><a href="/share/partClub总结.html" class="active sidebar-link">零件俱乐部总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/share/partClub总结.html#设计项目基础请求方法" class="sidebar-link">设计项目基础请求方法</a></li><li class="sidebar-sub-header"><a href="/share/partClub总结.html#可读写表单组件" class="sidebar-link">可读写表单组件</a></li><li class="sidebar-sub-header"><a href="/share/partClub总结.html#全局搜索组件" class="sidebar-link">全局搜索组件</a></li><li class="sidebar-sub-header"><a href="/share/partClub总结.html#工作空间列表" class="sidebar-link">工作空间列表</a></li><li class="sidebar-sub-header"><a href="/share/partClub总结.html#动态面包屑" class="sidebar-link">动态面包屑</a></li><li class="sidebar-sub-header"><a href="/share/partClub总结.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/share/gant-design小结.html" class="sidebar-link">gant-design小结</a></li><li><a href="/share/记又一次重装系统的历程.html" class="sidebar-link">记又一次重装系统的历程</a></li><li><a href="/share/百度云共享账号.html" class="sidebar-link">百度云共享账号</a></li><li><a href="/share/网络畅游.html" class="sidebar-link">网络畅游</a></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>零件俱乐部总结</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>Changero</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>2019-5-31</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      总结
    </span></i></div></div> <div class="content default"><p>零件俱乐部React版本的重构，是我加入甘棠的第一个项目，自<code>18年12月10日</code>开始到今天，算来也有半年的时间了。经过4、5位同事的共同努力，也总算是取得了阶段性胜利。</p> <p><strong>在项目中，我主要负责的部分有</strong></p> <p><a href="#%E8%AE%BE%E8%AE%A1%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><strong>1、设计项目基础请求方法，对接后端返回的数据</strong></a></p> <p><a href="#%E5%8F%AF%E8%AF%BB%E5%86%99%E8%A1%A8%E5%8D%95%E7%BB%84%E4%BB%B6"><strong>2、编写项目基础可读写表单组件。目前，会将这些组件重构以后放到公司的私有镜像上</strong></a></p> <p><a href="#%E5%85%A8%E5%B1%80%E6%90%9C%E7%B4%A2%E7%BB%84%E4%BB%B6"><strong>3、重构了一下项目中的全局搜索组件</strong></a></p> <p><a href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E5%88%97%E8%A1%A8"><strong>4、工作空间列表的数据管理</strong></a></p> <p><a href="#%E5%8A%A8%E6%80%81%E9%9D%A2%E5%8C%85%E5%B1%91"><strong>5、处理面包屑以及动态加载面包屑</strong></a></p> <p><strong>6、moment国际化处理</strong></p> <p><strong>7、图片缓存处理</strong></p> <p><strong>8、iconfont自动获取链接的脚本编写</strong></p> <p><strong>9、页面访问历史记录</strong></p> <p>10、编写部分业务页面</p> <p>等等。</p> <p>项目是采用的<code>ant-design-pro</code>的架子，因此也用到了<code>umi</code>以及<code>dva</code>。在整个重构过程中，也在不断的学习，如何编写具有可读性的代码，也越来越注重所写代码的性能。在学习高阶组件的过程中，接触到了<code>recompose</code>，也让我对<code>函数式编程</code>有了一个认识，这对于学习和阅读<code>redux</code>有极大的帮助。接下来分别简单的阐述一下上面提到的几点工作</p> <h2 id="设计项目基础请求方法"><a href="#设计项目基础请求方法" aria-hidden="true" class="header-anchor">#</a> 设计项目基础请求方法</h2> <p>如果说设计请求方法仅仅是去对接后端返回的数据的话，实在没有必要单独拿出来说一下。只因为在所有的请求中，有一个非常重要的参数需要处理，所以单独提出来说一说，记录一下。</p> <p>问题很简单，就是在所有的请求中，有一个初始请求，会返回一个请求都需要的参数，这个参数会被处理到header中。但是我们并没有使用<code>axios</code>这样的请求库，有<code>Intercept</code>这样的API可以使用，而是使用的fetch，所以只能手动的去处理这个拦截。毕竟请求是异步的，我们不能手动去控制先请求哪个，后请求哪个。</p> <p>那么，接下来一步一步的来设计一个方法来解决这个问题</p> <p>首先，我们有一个基础的请求方法，这个基础请求方法，处理options，然后调用<code>fetch</code>，并处理<code>response</code>之后的逻辑，它看起来像这样</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">basicRequest</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// config transform options ...</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>checkStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>checkResponse<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>其中，<code>checkStatus</code>是校验HTTP状态码的方法，必要的时候将消息反馈到界面上。<code>checkResponse</code>就主要是处理后端返回的消息及数据，根据<code>state</code>字段，展示不同的反馈和消息</p> <p>接下来就是request部分</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// serviceId是调用后端业务模块的ID</span>
<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">serviceId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> data<span class="token punctuation">,</span> conf</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        serviceId
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// resolve options and data</span>
        <span class="token function">basicRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在这里我们不能直接调用<code>basicRequest</code>，因为一旦调用就没法达到拦截的目的了。于是在这里采用了Promise的异步特性(当然也可以采用async/await语法，因为不过是一种语法糖而已)，来使程序暂停下来。暂停的条件就是判断时候有哪个id参数(与serviceId不同，记为spaceId)。但是又不能全部都拦截，因为初始的请求是一定可以执行的。所以我在options对象里面添加了一个<code>needId</code>的标志，来标记是否需要哪个Id。所以request现在像这样</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// serviceId是调用后端业务模块的ID</span>
<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">serviceId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> data<span class="token punctuation">,</span> conf</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        serviceId
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> need<span class="token punctuation">,</span> <span class="token operator">...</span>extra <span class="token punctuation">}</span> <span class="token operator">=</span> options

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>need<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// resolve options and data</span>
        <span class="token function">basicRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这样初始请求就能够正常的执行了。</p> <p>那么现在就是处理非初始请求了，需要去判断spaceId是否存在。如果有，则执行resolve，如果没有则需要将resolve暂存起来，保留现场。所以我们需要创建一个结构来存储这个spaceId，与暂存的待处理的数组</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token punctuation">{</span>
    spaceId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    taskes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">serviceId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> options<span class="token punctuation">,</span> data<span class="token punctuation">,</span> conf</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// some code</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>need <span class="token operator">||</span> store<span class="token punctuation">.</span>spaceId<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            store<span class="token punctuation">.</span>taskes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token comment">// 等待被恢复</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">// somecode</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>到这里，拦截的工作就已经做完了，其实来看原理很简单，就是利用Promise的异步特性，根据条件暂存resolve，来达到拦截的目的。通过在外部创建一个所有方法共享的数组去管理暂存的数组</p> <p>好了，这一步就要思考如何来告知store去遍历taskes恢复每一个请求了。既然是通知，很自然的就想到了事件模块，通过订阅发布模式来控制。我们可以自己构造一个事件模块，也可以采用node中的events模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// request.js</span>
<span class="token keyword">import</span> event <span class="token keyword">from</span> <span class="token string">'./event'</span>
event<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'spaceIdOk'</span><span class="token punctuation">,</span> <span class="token parameter">id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span>taskes<span class="token punctuation">.</span><span class="token function">formEach</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    store<span class="token punctuation">.</span>taskes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// index.js</span>
<span class="token keyword">import</span> event <span class="token keyword">from</span> <span class="token string">'./event'</span>
<span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">spaceId</span> <span class="token operator">=&gt;</span> event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'spaceIdOk'</span><span class="token punctuation">,</span> spaceId<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>到这里，基本主要的功能就完成了，接下来就是关于保存spaceId，让往后的请求也能够使用到这个Id了。</p> <p>当然也可以不采用store.taskes数组，可以直接在push操作的地方改换成事件监听，只是这样做的不好的一点就是如果暂存的请求很多，无法控制请求的节奏，而通过数组统一集中管理所有的暂存可以来控制这个节奏</p> <h2 id="可读写表单组件"><a href="#可读写表单组件" aria-hidden="true" class="header-anchor">#</a> 可读写表单组件</h2> <p>项目中的组件都是基于antd组件库来编写的。对于这个需求，最开始是设计一个基类组件来处理所有公共功能，其他组件通过继承的方式来重写特殊的业务逻辑。但是发现继承是形式是不很好，尤其是重写的方法无法执行的时候，更让我选择了放弃继承的方式来组合。</p> <p>所以后面的项目里面打算通过HOC的形式来重构所有的表单组件。而不采用Hooks的原因是其目前还无法做到渲染拦截，一个场景就是根据props和state计算某个结果，判断时候显示组件，以及组件的哪个形态，而Hooks还没有关于对Porps的支持。但是这个事情不绝对，自定义Hooks或许可以使用</p> <h2 id="全局搜索组件"><a href="#全局搜索组件" aria-hidden="true" class="header-anchor">#</a> 全局搜索组件</h2> <p>最开始的全局搜索组件，组件的值通过model管理，所以在<code>onChange</code>的时候，每次都使用dispatch传递，然后经由props，更新到组件。我发现这一过程是比较缓慢的，如果电脑性能稍差一点，便出现了卡顿的现象。于是我把值的管理从model中提出来，放到State里面（在实际中，我是通过HOC来进行管理），change时候的相应速度得到了不错的提升</p> <p>另一个问题是，需要搜索功能的页面如何得到输入框的反馈。我沿用了之前代码里面的注册机制，只是把注册是能力交由event模块来处理。这样，在业务页面中，只需要通过dispatch，将回调函数传递过去就可以了，至于什么时候调用，就完全由searchModel决定了。而之所以不在page中直接通过event注册，只是因为不想将event暴露出去，增加API量。这样，在输入框搜索的时候，便能触发相应页面所注册的回调函数，以达到搜索的目的了。</p> <p>优化的目的，是较少effect的调用，因为这个过程真的很慢，尤其是在effect中，通过select拿取特定数据的时候同步执行异步函数，又增加了等待的时间。而这些仅仅只需优化state数据的结构，来减少不必要的操作，就可以达到效果</p> <h2 id="工作空间列表"><a href="#工作空间列表" aria-hidden="true" class="header-anchor">#</a> 工作空间列表</h2> <p>因为项目中多处使用到工作空间列表的数据，而在此之前，所有的数据都是零散的分布在各个model中，难以集中管理，无法有效的完成某些功能。比如修改详情无法及时同步到其他模块的数据上去，于是决定，单独建立一个管理工作空间的model。在这个过程当中，我也渐渐意识到，功能的完成不能仅仅已实现为唯一目标，还应该关注在我们所写的代码的执行效率如何。尤其是像工作空间列表这样数据量较大的情况，而且还是试图关联的数据，方法的执行效率显得更为重要，往往这个时候我会选择以空间换取时间的办法来处理。</p> <p>所有的列表数据都来自一个请求接口，这也是统一管理想法的来源。但是在这数据中，又有展示位置的不同，有的表示可用的，有的表示关闭的，有的是展示当前的搜索结果，所以只能针对不同的状态，和展现的位置来进一步分化。于是，将所有需要分化的结果，在一次循环中完成，避免多次循环，造成浪费。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token keyword">const</span> filter <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token constant">IN_USE</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token constant">CLOSED</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> available <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> list<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                result<span class="token punctuation">[</span>item<span class="token punctuation">.</span>status<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 根据搜索条件</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            result<span class="token punctuation">[</span>item<span class="token punctuation">.</span>status<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token comment">// 根据状态分离</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'IN_USE'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//可用</span>
            available<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这样，就初步完成了初始化的过程中，数据的分离。分离的目标有三个，开启与关闭的，同时也受搜索条件的影响。可用列表仅仅表示当前可用的数据，不受搜索条件的影响。当改变搜索条件的时候，我们只会更新前两个数组，对于可用数据是不需要更新的。于是，在此基础上，我们只需要添加一个参数标记当前是否是初始化的执行即可</p> <h2 id="动态面包屑"><a href="#动态面包屑" aria-hidden="true" class="header-anchor">#</a> 动态面包屑</h2> <p>ant-design-pro中有专门处理面包屑的组件，但是它需要提前在router.config中配置好相应路径的name，以展示在面包屑上。但是这对于访问详情页面来说十分不友好，因为我们希望在访问到对应物件的详情上的时候，面包屑上应该显示物件对应的名称，而不是一个固定的名称。尤其是在系统中还有历史记录的情况下，名称更有助于我们去区分不同的物件。</p> <p>于是动态更新面包屑名称的需求就显得很重要了。通过在获取详情信息之后提交一个action，actio中包含有需要更新的路径以及更新的名称。通过遍历就能找到更新的位置，并传递新数据到面包屑组件上去</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>在项目的重构过程当中遇到的许多问题，都通过自己的思考或者别人提供的工具来进行解决。当然，更多的是增长了自己的经验，包括技能方面的增长、明确自己在团队当中的作用，努力的输出。写好注释，保证他人能有效的阅读。代码要以尽量简单的写法去完成功能。还有就是要保持自己谦虚的学习心态，有好多好多有意思的东西等着去学习，在下一个项目中需要用到的工具又要好好从头复习一下了，less、webpack、babel、jest等等</p></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于: </span> <span class="time">6/20/2019, 12:01:45 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/share/node-commander.html" class="prev">
          node命令行工具
        </a></span> <span class="next"><a href="/share/gant-design小结.html">
          gant-design小结
        </a>
        →
      </span></p></div> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3771b3c4.js" defer></script><script src="/assets/js/5.aeb3d5b3.js" defer></script><script src="/assets/js/1.8be823b2.js" defer></script><script src="/assets/js/51.d9e503ee.js" defer></script>
  </body>
</html>
