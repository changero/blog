---
title: 微前端基础架构实现
date: "2021-09-20 09:05:16"
categories:
  - 前端
lang: zh-cn
---

```html
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>微前端框架</title>
  </head>
  <body>
    <div><a href="#/app1">app1</a><a href="#/app2">app2</a></div>
    <div id="app"></div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/history/5.0.1/history.development.js"
      integrity="sha512-7DrORdMyn2/vC6cuhDZpxOK7WCuPHEpCX7Ozd0FitHzstm/WI9m3pubxSZH6a6otvq6Liq+6hSG8eOiDAOZFKA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="./micro.js"></script>
    <script>
      const appContainer = document.querySelector("#app");
      new SingleApp(
        "app1",
        async () => {
          let oldData = appContainer.innerText;
          let data = null;
          return {
            bootstrap: async (props) => {
              console.log(props, "bootstrap");
              data = "app1";
            },
            mount: async (props) => {
              console.log(props, "mount");
              appContainer.innerText = data;
            },
            unmount: async () => {
              appContainer.innerText = oldData;
            },
          };
        },
        (location) => location.hash.startsWith("#/app1"),
        {
          name: "123",
        }
      );
      new SingleApp(
        "app2",
        async () => {
          let oldData = appContainer.innerText;
          let data = null;
          return {
            bootstrap: async (props) => {
              console.log(props, "bootstrap2");
              data = "app2";
            },
            mount: async (props) => {
              console.log(props, "mount2");
              appContainer.innerText = data;
            },
            unmount: async () => {
              appContainer.innerText = oldData;
            },
          };
        },
        (location) => location.hash.startsWith("#/app2"),
        {
          name: "app2",
        }
      );

      start();
    </script>
  </body>
</html>
```

```js
const _history = HistoryLibrary.createHashHistory();

_history.listen(({ action, location }) => {
  const path = location.pathname;
  apps.forEach((app) => {
    reroute.call({ app });
  });
});

const apps = [];

function start() {
  apps.forEach((app) => {
    reroute.call({ app });
  });
}

async function reroute() {
  if (this.app.resolve) return this.app.resolve;
  if (this.app.status == "not_load" || this.app.status == "unmounted") {
    const { bootstrap, mount, unmount } = await this.app.loadApp();
    this.app.bootstrap = bootstrap;
    this.app.mount = mount;
    this.app.unmount = unmount;
    await bootstrap(this.app.store);
    this.app.status = "not_mount";
  }

  const shouldMount = this.app.when(new URL(location.href));
  if (this.app.status === "not_mount" && shouldMount) {
    await this.app.mount(this.app.store);
    this.app.status = "mounted";
  }
  if (this.app.status === "mounted" && !shouldMount) {
    await this.app.unmount(this.app.store);
    this.app.status = "unmounted";
  }
  delete this.app.resolve;
  return this.app;
}

class SingleApp {
  constructor(name, loadApp, when, store) {
    this.name = name;
    this.loadApp = loadApp;
    this.when = when;
    this.store = store;
    this.app = {
      name,
      loadApp: loadApp,
      when,
      store,
      status: "not_load",
    };
    apps.push(this.app);
    this.app.resolve = reroute.call(this);
  }
}
```
